<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorator="layout/default"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>Index Page</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/index.css}">
</head>

<body>
    <div class="auth">
        <a href="/login" id="loginLink">ë¡œê·¸ì¸</a>
        <a href="/signup" id="signupLink">íšŒì›ê°€ì…</a>
        <span id="userEmail" style="display: none; margin-right: 10px;"></span>
        <button id="logoutBtn" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div layout:fragment="content">
        <div class="container">
            <div class="header">
                <h1>í•˜ìš°! ì¸ë°ìŠ¤ í˜ì´ì§€ì— ì˜¤ì…¨ìŠµë‹ˆë‹¤! ğŸ˜Š</h1>
            </div>

            <div class="user-role" style="color: #007bff">
                ì¼ë°˜ ì‚¬ìš©ì
            </div>
            <div class="user-role" style="color: #28a745">
                ë©¤ë²„ ì‚¬ìš©ì
            </div>
            <div class="user-role" style="color: #dc3545">
                ê´€ë¦¬ì ì‚¬ìš©ì
            </div>

            <div class="links">
                <a href="/user/user.do">ìœ ì € í˜ì´ì§€ë¡œ</a>
                <a href="/member/member.do">ë©¤ë²„ í˜ì´ì§€ë¡œ</a>
                <a href="/admin/admin.do">ê´€ë¦¬ì í˜ì´ì§€ë¡œ</a>
                <a href="/test/test">í…ŒìŠ¤íŠ¸</a>
                <button id="reissueTokenBtn">í† í° ì¬ë°œê¸‰</button>
            </div>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:src="@{/js/common.js}" th:inline="javascript"></script>
<script>
    fetchUserInfo();

    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    function fetchUserInfo() {
        const token = getTokenFromLocalStorage();

        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        axios.get('/api/me', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            withCredentials: true // ì¿ í‚¤ì™€ ê°™ì€ ìê²© ì¦ëª… í¬í•¨
        })
                .then(response => {
                    if (response.data.status) {
                        displayUserInfo(response.data.data);  // ì‚¬ìš©ì ì •ë³´ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
                    }
                })
                .catch(error => {
                    if (error.response && error.response.status !== 1) {
                        // alert("ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
                        // window.location.href = '/login';
                        console.log("íšŒì› ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
    }

    // ì‚¬ìš©ì ì •ë³´ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function displayUserInfo(userInfo) {
        // ë¡œê·¸ì¸ ë° íšŒì›ê°€ì… ë§í¬ ìˆ¨ê¸°ê¸°
        document.getElementById('loginLink').style.display = 'none';
        document.getElementById('signupLink').style.display = 'none';

        // ì‚¬ìš©ì ì´ë©”ì¼ í‘œì‹œ
        const userEmailElement = document.getElementById('userEmail');
        userEmailElement.textContent = `${userInfo.email} ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
        userEmailElement.style.display = 'inline';  // ì´ë©”ì¼ í‘œì‹œ

        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
        document.getElementById('logoutBtn').style.display = 'inline';
    }

    // í† í° ì¬ë°œê¸‰ ìš”ì²­ í•¨ìˆ˜
    function requestTokenReissue() {
        axios.post('/reissue', {}, {
            headers: {
                'Content-Type': 'application/json'
            },
            withCredentials: true  // ì¿ í‚¤ í¬í•¨ ìš”ì²­
        })
                .then(response => {
                    if (response.status === 200) {
                        console.log("í† í° ì¬ë°œê¸‰ ì„±ê³µ:", response.data);

                        // Authorization í—¤ë”ì—ì„œ ìƒˆë¡œìš´ Access Token ì¶”ì¶œ
                        const authHeader = response.headers.authorization;
                        if (authHeader && authHeader.startsWith('Bearer ')) {
                            const newAccessToken = authHeader.split(' ')[1];

                            // ìƒˆë¡œìš´ Access Tokenì„ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                            saveTokenToLocalStorage(newAccessToken);
                            alert("í† í°ì´ ì„±ê³µì ìœ¼ë¡œ ì¬ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        } else {
                            console.error("Authorization í—¤ë”ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        }
                    }
                })
                .catch(error => {
                    console.error("í† í° ì¬ë°œê¸‰ ì‹¤íŒ¨:", error.response.data.message);
                    alert(error.response.data.message)
                    // alert("í† í° ì¬ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                });
    }

    // ì˜ˆì œ: ë²„íŠ¼ í´ë¦­ ì‹œ í† í° ì¬ë°œê¸‰ ìš”ì²­
    document.getElementById('reissueTokenBtn').addEventListener('click', requestTokenReissue);
</script>
</html>